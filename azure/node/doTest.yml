#####################################################################  
# Azure pipeline : test and publish results
# github.com/sapiderman/pipelines  
####################################################################  
parameters:
  - name: testPath
    type: string
    default: './...'

steps:
  - task: NodeTool@0
    displayName: 'Install dependencies'    

  - task: Npm@1
    inputs:
      command: 'install' # Options: install, publish, custom
      workingDir: $(System.DefaultWorkingDirectory)'
      verbose: true # Optional

  - script: |
          set -ex          
          npm test
    workingDirectory: '$(System.DefaultWorkingDirectory)'
    displayName: 'Run unit test'

  - task: PublishTestResults@2
    displayName: 'Publish unit test results'
    inputs:
      testRunner: JUnit
      testResultsFiles: $(System.DefaultWorkingDirectory)/**/report.xml

  - task: PublishCodeCoverageResults@1
    displayName: 'Publish coverage'
    inputs:
      codeCoverageTool: 'Cobertura' #or JaCoco
      summaryFileLocation: 'coverage.xml'